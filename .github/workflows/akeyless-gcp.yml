name: Akeyless GCP (self-hosted)

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      access-id:
        description: 'The Akeyless GCP auth method Access ID'
        required: true
        type: string

jobs:
  akeyless-secrets:
    runs-on: [self-hosted]
    env:
      RUNNER_DEBUG: '1'
      ACTIONS_RUNNER_DEBUG: 'true'
    steps:
      - name: Debug CA cert format
        run: |
          CERT="${{ secrets.KGAL_AZURE_DEV_CA_CERT_PEM }}"
          echo "Length: ${#CERT}"
          echo "Contains newline (0=no, 1=yes): $(echo "$CERT" | grep -c $'\n' || true)"
          echo "First 50 chars: ${CERT:0:50}"
      - name: Retrieve Akeyless Secret (GCP auth)
        id: akeyless
        uses: akeyless-community/akeyless-github-action@v1.1.4
        with:
          api-url: https://kgal-azure.dev/api/v2
          ca-certificate: ${{ secrets.KGAL_AZURE_DEV_CA_CERT_PEM }}
          access-id: ${{ inputs.access-id || secrets.GCP_AKEYLESS_ACCESS_ID }}
          access-type: gcp
          gcp-audience: "akeyless.io"
          static-secrets: |
            - name: "/path/to/test1"
              output-name: "MY_SECRET"

      - name: Use secret
        run: |
          echo "Secret (masked) is set: ${{ steps.akeyless.outputs.MY_SECRET }}"